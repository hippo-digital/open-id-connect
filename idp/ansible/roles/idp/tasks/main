---
- name: Install Redis
  apt: name=redis-server state=present

- name: Update APT cache
  apt: update_cache=yes

- name: Install NGINX
  apt: name=nginx state=present

- name: Install Python3
  apt: name=python3 state=present

- name: Install Pip3
  apt: name=python3-pip state=present

- name: Install Python3 Dev
  apt: name=python3-dev state=present

- name: Install GIT
  apt: name=git state=present

- name: Create service user
  user: name=idpservice

- name: Clone application repo
  git: repo=https://github.com/hippodigital/open-id-connect.git dest=/home/idpservice/open-id-connect

- name: Install VirtualEnv
  pip: name=virtualenv state=present executable=pip3

- name: Install PyYAML
  pip: name=pyyaml state=present virtualenv=/home/idpservice/open-id-connect/idp/web virtualenv_python=python3

- name: Install PyRedis
  pip: name=redis state=present virtualenv=/home/idpservice/open-id-connect/idp/web virtualenv_python=python3

- name: Install UWSGI
  pip: name=uwsgi state=present virtualenv=/home/idpservice/open-id-connect/idp/web virtualenv_python=python3

- name: Install Flask
  pip: name=flask state=present virtualenv=/home/idpservice/open-id-connect/idp/web virtualenv_python=python3

- name: Install LDAP3
  pip: name=ldap3 state=present virtualenv=/home/idpservice/open-id-connect/idp/web virtualenv_python=python3

- name: Install Jose JWT
  pip: name=python-jose state=present virtualenv=/home/idpservice/open-id-connect/idp/web virtualenv_python=python3

- name: Create IDP Socket directory
  file: path=/var/idp state=directory mode=0777

- name: Create IDP Logs directory
  file: path=/var/log/idp state=directory mode=0777

- name: Create IDP Config directory
  file: path=/etc/idp state=directory mode=0755

- name: Set app directory permissions
  file: path=/home/idpservice/open-id-connect state=directory owner=idpservice group=idpservice recurse=yes

- name: IDP Config
  copy: src=hippo-idp dest=/etc/nginx/sites-available/ mode=0644

- name: IDP Service Config
  copy: src=hippo-idp.service dest=/etc/systemd/system/ mode=0755

- name: SSL Private Key
  copy: src=login.hippo.digital.key dest=/etc/idp mode=0600

- name: SSL Certificate
  copy: src=login.hippo.digital.pem dest=/etc/idp mode=0600

- name: Basic config.yml
  copy: src=config.yml dest=/etc/idp mode=0644

- name: Basic clients.yml
  copy: src=clients.yml dest=/etc/idp mode=0644

- name: Create symlink to login.hippo.digital
  file: src=/etc/nginx/sites-available/hippo-idp dest=/etc/nginx/sites-enabled/hippo-idp state=link
  #notify: nginx reload

- name: Create hippo-idp service (1)
  command: systemctl enable hippo-idp

- name: Create hippo-idp service (2)
  command: systemctl start hippo-idp

- name: Restart nginx
  command: service nginx restart


